name: Update hmcl-beta-bin

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: 

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Check for new version
        id: check
        run: |
          # Fetch latest preview release from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/HMCL-dev/HMCL/releases | \
            jq -r '[.[] | select(.prerelease == true)] | .[0].tag_name' | sed 's/^v//')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Get current version from PKGBUILD
          CURRENT_VERSION=$(grep '^pkgver=' hmcl-beta-bin/PKGBUILD | cut -d'=' -f2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "New version available: $LATEST_VERSION (current: $CURRENT_VERSION)"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date: $CURRENT_VERSION"
          fi

      - name: Download and calculate SHA256
        if: steps.check.outputs.needs_update == 'true'
        id: download
        run: |
          LATEST_VERSION="${{ steps.check.outputs.latest_version }}"
          URL="https://github.com/HMCL-dev/HMCL/releases/download/v${LATEST_VERSION}/HMCL-${LATEST_VERSION}.jar"

          echo "Downloading from: $URL"
          curl -L -o HMCL.jar "$URL"

          SHA256=$(sha256sum HMCL.jar | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

          rm HMCL.jar

      - name: Update PKGBUILD
        if: steps.check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.check.outputs.latest_version }}"
          SHA256="${{ steps.download.outputs.sha256 }}"

          # Update pkgver
          sed -i "s/^pkgver=.*/pkgver=$LATEST_VERSION/" hmcl-beta-bin/PKGBUILD

          # Reset pkgrel to 1
          sed -i "s/^pkgrel=.*/pkgrel=1/" hmcl-beta-bin/PKGBUILD

          # Update SHA256
          sed -i "s/^sha256sums=.*/sha256sums=('$SHA256')/" hmcl-beta-bin/PKGBUILD

          echo "PKGBUILD updated to version $LATEST_VERSION"

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update hmcl-beta-bin to ${{ steps.check.outputs.latest_version }}"
          title: "Update hmcl-beta-bin to ${{ steps.check.outputs.latest_version }}"
          body: |
            ## Auto Update hmcl-beta-bin

            - **New Version**: ${{ steps.check.outputs.latest_version }}
            - **Old Version**: ${{ steps.check.outputs.current_version }}
            - **SHA256**: `${{ steps.download.outputs.sha256 }}`

            This PR was automatically created by GitHub Actions.

            Please review the changes before merging.
          branch: update-hmcl-${{ steps.check.outputs.latest_version }}
          delete-branch: true
          labels: |
            automated
            pkgbuild-update
